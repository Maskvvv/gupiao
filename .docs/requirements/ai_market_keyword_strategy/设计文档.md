# 全市场自动推荐与关键词推荐策略升级 设计文档

版本：v1.0  
作者：AI 助手  
日期：2025-08-25

---

## 1. 背景与目标
当前系统已具备基于技术指标与 AI 建议的个股分析、全市场自动推荐与关键词筛选功能，但存在如下改进空间：
- 全市场候选池来自静态规则（全量+随机采样），未结合“当下市场行情”的动态信息构建股票池；
- 默认排序基于技术评分（或通过开关启用融合分），希望统一默认以“融合分”降序输出；
- 抽样倍数、过滤阈值、排序方式不可通过接口配置；
- AI 分析未提取“相关关键词”（如“华为概念/AI 概念/芯片”），无法回显/持久化用于二次检索。

目标：
1) 全市场自动推荐的股票池由 AI 结合当前行情生成；
2) 全市场自动推荐和关键词推荐均默认按“融合分”降序排序后截取；
3) 将“抽样倍数、阈值、排序方式”暴露为接口可选参数；
4) AI 分析个股时输出最相关关键词并持久化至数据库。

---

## 2. 现状梳理（Baseline）
- 分析核心类：EnhancedAnalyzer
  - 批量/AI 分析：analyze_with_ai、bulk_analyze
  - 全市场筛选：auto_screen_market（当前：随机采样 3 倍、按技术分数排序、阈值 0.4）
  - 关键词筛选：keyword_screen_market（当前：AI 初筛→再按技术分排序、阈值 0.3）
- 融合分模块：confidence_fusion（已提供 ai_confidence 解析与 fusion_score 计算；ENV CONF_FUSION_ALPHA）
- API 路由：routes.py
  - 请求模型已定义 MarketRecommendationRequest、KeywordRecommendationRequest
  - 目前排序在路由层使用 ENABLE_FUSION_SORT 环境变量控制是否采用融合分
- 持久化：Recommendation/RecommendationItem 与 AnalysisRecord 已持久化 ai_confidence、ai_confidence_raw、fusion_score，但未存储“相关关键词”。

---

## 3. 设计方案

### 3.1 用 AI 构建“动态市场股票池”
新增方法：ai_pick_market_pool(exclude_st, min_market_cap, board, ai_params, ai_pool_size=None)
- 输入：
  - exclude_st, min_market_cap, board：与 get_market_stocks 同源过滤条件
  - ai_params：AI 路由参数（provider/temperature/api_key）
  - ai_pool_size：AI 应返回的候选股票池规模上限；默认等于 max_candidates（未显式传入时按该默认值），可按需调小以提升速度
- 流程：
  1) 获取行情快照（东财/akshare）：涨跌幅前列、成交额/换手/振幅前列、板块/概念热度摘要（计算若干统计指标，形成“市场上下文 Summary”）；
  2) 构造提示词：告知 AI 当前市场的“活跃板块、强势风格（大盘/小盘）、资金方向、风险点”与基础约束（排除 ST、板块过滤、市值下限等）；
  3) 让 AI 输出“按当前行情最应重点跟踪的 N 支股票代码（6 位数字）”，按“流动性/景气/催化”综合而非仅涨幅；
  4) 解析代码并与 get_market_stocks 的结果求交集（确保有效性与一致性）；
  5) 回退策略：AI 失败时，退化为 get_market_stocks 结果中“成交额/换手率 TopK + 随机补齐”。
- 输出：去重有序的股票代码列表，长度不超过 ai_pool_size。

在 auto_screen_market 中替换股票池来源：
- 旧：market_stocks → random.sample(..., max_candidates*3)
- 新：market_stocks_ai = ai_pick_market_pool(...);
  - 抽样数量 = min(len(market_stocks_ai), max_candidates * sample_multiplier)
  - 分析后按 sort_by 排序，过滤 score/fusion_score 低于阈值的项

### 3.2 融合分排序默认化
- 默认排序方式：fusion（融合分降序）
- sort_by 支持：
  - fusion：融合分
  - tech：技术评分（原 score）
  - ai_confidence：AI 信心（0-10）
- 在 analyzer 方法与路由两层保持一致：
  - analyzer 内部用于“中间阶段”排序
  - 路由层用于“最终返回”排序
- 兼容策略：当 sort_by=fusion 且无 ai_confidence 时，融合分会退化为技术分（已由 extract_confidence_and_fusion 实现）。

### 3.3 将“抽样倍数、阈值、排序方式”暴露为接口参数
对两类请求模型扩展：
- MarketRecommendationRequest 新增：
  - sample_multiplier: int = 1   （抽样倍数，用于候选池分析量控制，默认 1×N，即第一种极简方案）
  - min_score_threshold: float = 0.4   （过滤阈值，融合分或技术分）
  - sort_by: Literal["fusion","tech","ai_confidence"] = "fusion"
  - ai_pool_size: int = 默认为 max_candidates  （AI 构建股票池的目标规模上限；未指定时等于 max_candidates）
- KeywordRecommendationRequest 新增：
  - analysis_limit_multiplier: int = 1  （关键词初筛后，进一步分析的倍数；默认 1×N）
  - min_score_threshold: float = 0.3
  - sort_by: 同上，默认 "fusion"

参数传递链路：路由 -> EnhancedAnalyzer.auto_screen_market/keyword_screen_market -> bulk_analyze/analyze_with_ai -> 融合分计算 -> 路由二次排序与持久化。

### 3.4 提取“相关关键词”并持久化
1) 提示词规范化：在多维分析提示中强制输出“相关关键词”行：
- 要求模型在首段或末段追加：
  - 相关关键词：华为概念, AI 概念, 芯片（用逗号分隔，2-5 个）
2) 关键词解析：
- 新增提取函数 extract_keywords(ai_text:str) -> List[str]
  - 优先匹配“相关关键词：”后的逗号分隔列表
  - 若未找到，回退规则：抓取“xx概念/板块/主题/行业”等常见词尾短语；清洗空白与重复
  - 边界处理：空或无匹配时返回空列表
3) 数据库 Schema 变更：
- recommendation_items 表新增：tags TEXT（JSON 存储字符串数组）
- analysis_records 表新增：tags TEXT（JSON 存储字符串数组）
- 迁移策略：
  - SQLite：PRAGMA 检查列缺失则 ALTER TABLE ADD COLUMN
  - MySQL：INFORMATION_SCHEMA 检查列缺失则 ALTER TABLE ADD COLUMN
4) 写入与返回：
- analyze/bulk_analyze 结果增加字段 keywords: List[str]
- 路由持久化时将 keywords 序列化为 JSON 存入 tags
- API 返回时将“相关关键词”直接返回给前端用于展示与检索

---

## 4. 详细流程说明

### 4.1 全市场自动推荐（增强后）
1) 获取基础股票全集并做初步过滤（exclude_st/min_market_cap/board）
2) 调用 ai_pick_market_pool 结合“当前行情摘要”让 AI 输出重点跟踪的股票池（<= ai_pool_size，且 ai_pool_size 默认等于 max_candidates）
3) 抽样：sample_multiplier 倍的 max_candidates 数量（cap 到股票池长度），用于控制分析耗时（默认 1×N）
4) 批量分析：bulk_analyze（内含 analyze_with_ai → 融合分提取与计算 + 关键词提取）
5) 过滤：score/fusion_score < min_score_threshold 的去除
6) 排序：按 sort_by（默认 fusion）降序
7) 截取：top N（N=max_candidates）
8) 持久化：Recommendation/RecommendationItem（含 ai_confidence/raw, fusion_score, tags）

### 4.2 关键词推荐（增强后）
1) 获取市场股票全集（同 4.1 第1步）
2) AI 初筛：_ai_keyword_filter（原有）
3) 分析集合：取前 analysis_limit_multiplier*max_candidates 只进入深度分析（默认 1×N）
4) 批量分析并提取关键词；按 min_score_threshold 过滤
5) 排序：sort_by（默认 fusion）降序
6) 截取：top N
7) 持久化：同上，含 tags

---

## 5. 接口与数据结构变更

### 5.1 请求模型变更（后端）
- MarketRecommendationRequest：新增 sample_multiplier, min_score_threshold, sort_by, ai_pool_size（ai_pool_size 默认等于 max_candidates；sample_multiplier 默认 1）
- KeywordRecommendationRequest：新增 analysis_limit_multiplier, min_score_threshold, sort_by（analysis_limit_multiplier 默认 1）

向后兼容：以上字段均为可选且有默认值，老客户端不受影响；默认排序改为融合分（与原 ENABLE_FUSION_SORT=0 的默认行为不同），如需保持旧行为可在请求中显式设置 sort_by=tech。

### 5.2 数据库存储变更
- recommendation_items：新增列 tags TEXT（JSON 数组），用于存储相关关键词
- analysis_records：新增列 tags TEXT（JSON 数组）

### 5.3 API 返回示例（片段）
- 单只推荐项新增字段：
  - 相关关键词：数组，如 ["AI 概念","华为概念","芯片"]

---

## 6. 提示词与解析策略

### 6.1 多维分析提示词（关键片段）
- 第一行：多维摘要（已存在）
- 正文：技术/宏观/事件（已存在）
- 最后一行：最终建议（已存在）
- 新增：
  - 相关关键词：用逗号分隔给出 2-5 个最相关的“概念/主题/行业/产业链”标签

### 6.2 解析关键词
- 首选正则定位“相关关键词：(.+)”抓取并按逗号/顿号分割；
- 兜底：扫描“xxx概念/主题/板块/行业/赛道/细分”等尾缀短语；
- 清洗：去空格、去重、限制最多 5 个。

---

## 7. 日志与观测性
- 重要节点打印结构化 DEBUG 日志：
  - ai_pick_market_pool：输入过滤条件、行情摘要生成耗时、AI 返回码数量、回退触发
  - analyze_with_ai：解析信心与关键词成功/失败、融合分结果
  - keyword_screen_market：两阶段进度、过滤后数量
- 注意保护敏感：不打印完整 API Key；提示词仅打印长度或哈希摘要。

---

## 8. 边界与回退
- AI 服务不可用：
  - 股票池：退化到 get_market_stocks + 成交额/换手 TopK + 随机补齐
  - 关键词：退化 _fallback_keyword_filter（已存在）
  - 融合分：无 ai_confidence 时退化为技术分（已实现）
- 数据为空：直接返回空列表，日志记录“数据不足/过滤后为空”。

---

## 9. 测试计划
- 单元测试：
  - 关键词解析：extract_keywords 多样化输入覆盖（标点/空格/中英文/无关键词）
  - 融合分：confidence_fusion 计算边界（无 AI 信心、越界截断）
- 集成测试：
  - /recommend/market 与 /recommend/keyword 在不同 sort_by/阈值/倍数组合下输出稳定
  - 启用/关闭 AI 构建股票池，结果可用且回退生效
- 回归测试：现有接口不带新参数依旧可用。

---

## 10. 实施步骤与排期（建议）
1) Schema 变更：新增 tags 列与轻量迁移逻辑（SQLite/MySQL）
2) 提示词升级与 extract_keywords 实现；analyze_with_ai 返回 keywords
3) ai_pick_market_pool 实现与 auto_screen_market 接入；关键词流程接入 sort_by/阈值/倍数
4) 路由请求体扩展与排序/返回结构更新（包含关键词）
5) 日志与配置梳理；文档与 README 更新；
6) 测试与回归；上线与观测。

---

## 11. 风险与缓解
- AI 输出代码不在 A 股：与原始股票池求交集、正则严格校验 6 位数字
- 提示词过长：限制样本数量并用摘要化的“市场上下文”输入
- 关键词质量参差：通过提示词明确格式、数量与类型；提供兜底规则
- 默认排序行为变化：通过 sort_by 显式指定可回退旧行为。

---

## 12. 影响范围
- 后端：EnhancedAnalyzer、routes、DB 迁移脚本与模型、日志
- 前端：展示“相关关键词”标签（UI 稍作适配）、参数化调用（可选）

---

## 13. 回溯链接（实现参考）
- 分析器：EnhancedAnalyzer（analyze_with_ai / auto_screen_market / keyword_screen_market / get_market_stocks）
- 融合分：confidence_fusion（ai_confidence 提取 + 融合分计算）
- 路由与模型：routes（请求体/排序/持久化）

## 14. 前端参数透传与配置项说明
为满足“新增配置参数均可由前端传入”的要求，本小节明确前端可配置项、默认值与建议范围，以及请求示例与校验规则。所有参数均为可选，未传入时由后端采用本文档给出的默认值。

- 适用接口（POST）
  - /api/recommend/market/start（全市场自动推荐）
  - /api/recommend/keyword/start（关键词推荐）

- 参数列表（前端可透传）
  - 通用/已存在：
    - max_candidates: int（最终返回的 Top N 数量；前端可控，后端有默认）
  - 全市场自动推荐（market）
    - sample_multiplier: int，可选，默认 1；建议范围 1-3（控制从 AI 候选池中进入深度分析的股票数量，= 倍数 × max_candidates）
    - min_score_threshold: float，可选，默认 0.4；建议 0.3-0.7（过滤低于阈值的融合分/技术分）
    - sort_by: "fusion" | "tech" | "ai_confidence"，可选，默认 "fusion"（排序方式）
    - ai_pool_size: int，可选，默认等于 max_candidates；建议 1-3×max_candidates（AI 生成的候选池目标规模上限）
  - 关键词推荐（keyword）
    - keyword: string，必填（主题/概念关键字）
    - analysis_limit_multiplier: int，可选，默认 1；建议范围 1-3（关键词初筛后进入深度分析的倍数）
    - min_score_threshold: float，可选，默认 0.3；建议 0.2-0.6
    - sort_by: 同上，默认 "fusion"

- 请求示例（JSON）
  - /api/recommend/market/start：
    {
      "max_candidates": 10,
      "sample_multiplier": 1,
      "min_score_threshold": 0.4,
      "sort_by": "fusion",
      "ai_pool_size": 10,
      "exclude_st": true,
      "min_market_cap": 50,
      "board": "主板"
    }
  - /api/recommend/keyword/start：
    {
      "keyword": "AI 概念",
      "max_candidates": 10,
      "analysis_limit_multiplier": 1,
      "min_score_threshold": 0.3,
      "sort_by": "fusion",
      "exclude_st": true,
      "min_market_cap": 30,
      "board": "科创板"
    }

- 返回字段约定（与第 5.3 节一致）
  - 每个推荐项新增/包含：keywords（字符串数组），示例：["AI 概念","华为概念","芯片"]
  - 兼容性：旧版本可能没有 keywords 字段；前端需做空值/缺失判断，缺失时可隐藏关键词区域

- 前端校验与兜底
  - 数值边界：
    - sample_multiplier, analysis_limit_multiplier < 1 时按 1 处理；> 10 可提示并裁剪到 10
    - min_score_threshold < 0 或 > 1 时提示并裁剪到 [0,1]
    - ai_pool_size < 1 时按 max_candidates 处理；> 5×max_candidates 可警告“过大影响性能”
  - 交互建议：将“排序/阈值/倍数/池规模”等放入“高级选项”折叠面板，维持默认即可一键出结果

- 透传链路
  前端（表单/设置）→ 请求体参数 → 后端 routes → EnhancedAnalyzer（auto_screen_market / keyword_screen_market）→ analyze/bulk_analyze & 融合分 → 返回 JSON（含 keywords）


## 15. 前端“相关关键词”展示规范
为满足“相关关键词要在前端相关地方展示”的要求，规范列表页与详情页的呈现方式与交互。

- 数据来源
  - 使用返回字段 keywords: string[]（等价于“相关关键词”），若为空或缺失则不展示
  - 兼容后端历史字段 tags（数据库列名），后端会统一映射为 keywords 返回

- 列表页（推荐结果列表/卡片）
  - 展示位置：股票名称/代码下方，使用标签（Tag/Chip）样式
  - 数量与折叠：默认展示最多 3 个标签，超出以“+N” 展示；悬浮/点击可查看全部
  - 交互：
    - 点击单个关键词 → 直接发起关键词推荐（/api/recommend/keyword/start，keyword=该标签）
    - 悬浮提示（tooltip）：展示完整关键词列表，避免占用空间
  - 边界处理：关键词为空 → 隐藏标签区；单个关键词过长 → 截断并 tooltip 显示全文

- 详情页（若有）
  - 展示全部关键词，支持一键复制
  - 可选：提供“基于此关键词继续筛选”按钮

- 过滤/检索（可选增强）
  - 在结果页顶部提供“关键词筛选器”：支持包含/排除若干标签（多选）
  - 点击某个标签后在筛选器中自动选中该标签以便二次筛选

- 无障碍与视觉规范
  - 标签颜色与背景需保证对比度；移动端换行显示
  - 标签数量上限建议 8 个；超出以折叠方式处理

- 指导性 UI 提示（示例文案）
  - “关键词用于快速识别概念与主题，点击即可展开该主题下的推荐”

（完）