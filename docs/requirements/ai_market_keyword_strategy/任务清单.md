# AI 驱动全市场/关键词推荐 升级 — 任务清单（可独立验收）

版本：v1.0  
对应设计文档：设计文档.md  
说明：每个任务具备原子性，边界清晰，依赖最小化，包含明确的验收标准。

---

勾选清单（进度总览）
- 使用方法：将 [ ] 改为 [x] 即可标注完成；下方仍保留每个任务的详细说明与验收标准。
- 当前完成：0/21

- [ ] 1. 数据库迁移：新增 tags 字段（SQLite/MySQL）
- [ ] 2. 请求模型扩展：MarketRecommendationRequest 新增参数
- [ ] 3. 请求模型扩展：KeywordRecommendationRequest 新增参数
- [ ] 4. 提示词升级：强制输出“相关关键词”行
- [ ] 5. 关键词解析函数：extract_keywords
- [ ] 6. analyze_with_ai 返回结构扩展：包含 keywords 字段
- [ ] 7. AI 股票池：实现 ai_pick_market_pool
- [ ] 8. auto_screen_market 接入新参数与 AI 股票池
- [ ] 9. keyword_screen_market 扩展
- [ ] 10. 路由层：最终排序与持久化调整
- [ ] 11. 日志与敏感信息保护
- [ ] 12. 单元测试：extract_keywords
- [ ] 13. 单元测试：融合分边界
- [ ] 14. 集成测试：/api/recommend/market/start
- [ ] 15. 集成测试：/api/recommend/keyword/start
- [ ] 16. 前端：新增“高级选项”面板与参数透传（market）
- [ ] 17. 前端：新增“高级选项”面板与参数透传（keyword）
- [ ] 18. 前端：列表展示 keywords 标签
- [ ] 19. 前端：点击关键词发起关键词推荐
- [ ] 20. 前端（可选增强）：关键词筛选器
- [ ] 21. 文档更新：README 与接口说明

---

1. 数据库迁移：新增 tags 字段（SQLite/MySQL）
- 内容：为 recommendation_items 与 analysis_records 新增列 tags TEXT（JSON 数组）。存在即跳过。
- 依赖：无。
- 验收标准：
  - SQLite/MySQL 两种模式均可自动迁移成功，无数据丢失。
  - 新增记录时可写入 JSON 数组字符串（如 ["AI 概念","芯片"]）。
  - 迁移过程打印 INFO 级日志，出错有清晰异常与回滚提示。

2. 请求模型扩展：MarketRecommendationRequest 新增参数
- 内容：新增 sample_multiplier(int, 默认1)、min_score_threshold(float, 默认0.4)、sort_by(enum, 默认"fusion"), ai_pool_size(int, 默认= max_candidates)。
- 依赖：无。
- 验收标准：
  - 启动后接口可接收并通过校验，未传参走默认值。
  - OpenAPI/Schema 显示新增字段及默认值。

3. 请求模型扩展：KeywordRecommendationRequest 新增参数
- 内容：新增 analysis_limit_multiplier(int, 默认1)、min_score_threshold(float, 默认0.3)、sort_by(enum, 默认"fusion")。
- 依赖：无。
- 验收标准：
  - 启动后接口可接收并通过校验，未传参走默认值。
  - OpenAPI/Schema 显示新增字段及默认值。

4. 提示词升级：强制输出“相关关键词”行
- 内容：在 analyze_with_ai 的提示词模板中，明确要求模型输出“相关关键词：xxx, yyy”格式（2-5 个）。
- 依赖：无。
- 验收标准：
  - 调用 AI 时日志中可看到提示词包含“相关关键词：”要求（可隐藏关键密钥）。
  - AI 正常返回时，常见用例里能够包含该行文本。

5. 关键词解析函数：extract_keywords
- 内容：新增 extract_keywords(ai_text:str)->List[str]，优先解析“相关关键词：”行；兜底从文本中提取“xx概念/主题/板块/行业”等短语；去重、最多5个。
- 依赖：任务4（提示词升级）可选。
- 验收标准：
  - 单测覆盖：标准格式、无该行、英文/中英文混排、冗余空格、重复词、空输入。
  - 所有用例通过，返回稳定、无异常。

6. analyze_with_ai 返回结构扩展：包含 keywords 字段
- 内容：在现有返回中追加 keywords: List[str]；空缺时返回 []。
- 依赖：任务5。
- 验收标准：
  - 路由中拿到的单条分析结果包含 keywords 字段。
  - 关键路径无 KeyError/NoneType 异常。

7. AI 股票池：实现 ai_pick_market_pool
- 内容：生成“行情摘要”→ 构建提示词 → 调用 AI 返回候选股票 → 解析并与有效股票集求交集；失败时回退（成交额/换手 TopK + 随机补齐）。
- 依赖：无（独立实现）。
- 验收标准：
  - 正常路径：返回不超过 ai_pool_size 的 6 位代码列表，且都在有效股票集合内。
  - 失败路径：AI 报错或返回空时触发回退，仍能返回非空（在有市场数据的情况下）。
  - 关键节点有 DEBUG/INFO 日志，且不泄露敏感信息。

8. auto_screen_market 接入新参数与 AI 股票池
- 内容：替换随机采样为 ai_pick_market_pool，支持 sample_multiplier、min_score_threshold、sort_by；默认按融合分排序并截取 max_candidates。
- 依赖：任务2、7。
- 验收标准：
  - 不传参数时默认行为符合设计（1×N 抽样、融合分排序、阈值0.4）。
  - 传参后能改变抽样量/阈值/排序；返回数量= max_candidates。

9. keyword_screen_market 扩展
- 内容：支持 analysis_limit_multiplier、min_score_threshold、sort_by；关键流程中返回含 keywords。
- 依赖：任务3、5、6。
- 验收标准：
  - 不传参数时默认行为符合设计（1×N 深度分析、融合分排序、阈值0.3）。
  - 传参后可改变分析量/阈值/排序；返回数量= max_candidates。

10. 路由层：最终排序与持久化调整
- 内容：路由按 sort_by（默认 fusion）做最终排序；将分析结果中的 keywords 序列化为 JSON 写入 tags 列；响应中返回 keywords。
- 依赖：任务1、2、3、6、8、9。
- 验收标准：
  - 返回 JSON 的每条推荐项含 keywords 字段；DB 中 tags 列落库成功。
  - sort_by=fusion/tech/ai_confidence 三种排序均正确；无 ai_confidence 时融合分退化为技术分仍可用。

11. 日志与敏感信息保护
- 内容：为 ai_pick_market_pool、analyze_with_ai、keyword_screen_market 关键节点增加结构化 DEBUG/INFO 日志；隐藏敏感配置与密钥。
- 依赖：无。
- 验收标准：
  - 打开 DEBUG 后能看到步骤、数量、耗时等关键信息；日志不包含 API Key 明文。

12. 单元测试：extract_keywords
- 内容：针对任务5的解析逻辑编写 pytest 用例。
- 依赖：任务5。
- 验收标准：
  - pytest 全部通过；边界用例覆盖率符合预期（至少 6 组不同输入）。

13. 单元测试：融合分边界
- 内容：补充 confidence_fusion 的边界用例（无/越界 ai_confidence 等）。
- 依赖：无（可直接覆盖现有模块）。
- 验收标准：
  - pytest 通过；无越界异常；结果符合公式预期。

14. 集成测试：/api/recommend/market/start
- 内容：覆盖 sort_by（3类）、min_score_threshold（高/低）、sample_multiplier（1/2/3）、ai_pool_size（默认/自定义）的组合。
- 依赖：任务2、7、8、10。
- 验收标准：
  - 各组合均返回 200；返回数量= max_candidates；排序/阈值生效；keywords 字段存在且类型正确。

15. 集成测试：/api/recommend/keyword/start
- 内容：覆盖 sort_by、min_score_threshold、analysis_limit_multiplier 的常见组合；keyword 取典型主题词。
- 依赖：任务3、9、10。
- 验收标准：
  - 各组合均返回 200；返回数量= max_candidates；排序/阈值生效；keywords 字段存在且类型正确。

16. 前端：新增“高级选项”面板与参数透传（market）
- 内容：在全市场推荐入口增加可选配置项：sample_multiplier、min_score_threshold、sort_by、ai_pool_size；默认收起。
- 依赖：任务2、8、10（后端已支持）。
- 验收标准：
  - 未配置时使用默认；配置后请求体包含相应字段；前端做基础校验与边界裁剪。

17. 前端：新增“高级选项”面板与参数透传（keyword）
- 内容：在关键词推荐入口增加 analysis_limit_multiplier、min_score_threshold、sort_by 配置；默认收起。
- 依赖：任务3、9、10。
- 验收标准：
  - 未配置时使用默认；配置后请求体包含相应字段；校验与裁剪生效。

18. 前端：列表展示 keywords 标签
- 内容：在推荐结果卡片中展示关键词标签（最多3个，多余以“+N”折叠；tooltip 展示全部）。
- 依赖：任务10（后端返回 keywords）。
- 验收标准：
  - 有关键词时按规则展示；无或空时隐藏区域；长词语截断+tooltip 完整显示。

19. 前端：点击关键词发起关键词推荐
- 内容：用户点击某个标签，自动以该标签为 keyword 调用 /api/recommend/keyword/start 并刷新结果。
- 依赖：任务18。
- 验收标准：
  - 点击后出现 Loading，返回后列表更新；请求参数正确；可返回上一层。

20. 前端（可选增强）：关键词筛选器
- 内容：在结果页顶部提供“包含/排除”多选筛选器，仅在前端对现有结果做过滤（不强制后端）。
- 依赖：任务18。
- 验收标准：
  - 选择后即时过滤列表；清空恢复；移动端可用；无报错。

21. 文档更新：README 与接口说明
- 内容：补充新参数说明、返回包含 keywords 字段示例、前端使用指引（与设计文档第14/15节一致）。
- 依赖：任务2、3、10、16-19 完成后更新。
- 验收标准：
  - README 中新增章节完整准确；示例可复制使用；与实现一致。

---

备注：若需进一步最小化依赖，前端任务 20 可延后或取消，不影响核心功能闭环（参数透传 + 关键词展示与跳转）。